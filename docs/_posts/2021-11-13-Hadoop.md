```yaml

layout: post
title: "牛蛙"
date: 2021-11-13 17:04:55 -0000
categories: 日记 随笔
```

# Hadoop

## 使用docker模拟服务器集群

## 新建一个linux镜像

```shell
docker pull centos:8
```

## 使用docker images查看本地镜像

```shell
docker images
```

## 新建一个容器

```shell
docker run -d centos:8 /usr/sbin/init
```

## 查看运行中的容器

```shell
docker ps
```

## 使用新创建的容器输出hello world

```shell
docker exec dsafjasfsafa echo "hello world"
```

## 配置java和SSh环境

## 新建容器

```sh
docker run -d --name=java_ssh_proto --privileged centos:8 /usr/sbin/init
```

## 进入容器

```shell
docker exec -it java_ssh_proto bash
```

## 配置镜像

```shell
sed -e 's|^mirrorlist=|#mirrorlist=|g' \
         -e 's|^#baseurl=http://mirror.centos.org/$contentdir|baseurl=https://mirrors.ustc.edu.cn/centos|g' \
         -i.bak \
         /etc/yum.repos.d/CentOS-Linux-AppStream.repo \
         /etc/yum.repos.d/CentOS-Linux-BaseOS.repo \
         /etc/yum.repos.d/CentOS-Linux-Extras.repo \
         /etc/yum.repos.d/CentOS-Linux-PowerTools.repo \
         /etc/yum.repos.d/CentOS-Linux-Plus.repo
yum makecache
```

## 安装 OpenJDK 8 和 SSH 服务：

```bash
yum install -y java-1.8.0-openjdk-devel openssh-clients openssh-server
```

## 启用SSH

```bash
systemctl enable sshd && systemctl start sshd
```

## 保存为一个名为 java_ssh 的镜像

```bash
docker stop java_ssh_proto
docker commit java_ssh_proto java_ssh
```

## Hadoop 安装

### 下载 Hadoop

Hadoop 官网地址：http://hadoop.apache.org/

Hadoop 发行版本下载：https://hadoop.apache.org/releases.html

在目前的测试中，3.1.x 与 3.2.x 版本的兼容性较佳，本教程使用 3.1.4 版本作为案例。

Hadoop 3.1.4 镜像地址，下载好 tar.gz 压缩包文件备用。

### 创建 Hadoop 单机容器

现在以之前保存的 java_ssh 镜像创建容器 hadoop_single：

```bash
docker run -d --name=hadoop_single --privileged java_ssh /usr/sbin/init
```

将下载好的 hadoop 压缩包拷贝到容器中的 /root 目录下：

```bash
docker cp <你存放hadoop压缩包的路径> hadoop_single:/root/
```

进入容器：

```
docker exec -it hadoop_single bash
```

进入 /root 目录：

```
cd /root

```

这里应该存放着刚刚拷贝过来的 hadoop-x.x.x.tar.gz 文件，现在解压它：

```
tar -zxf hadoop-3.1.4.tar.gz
```

解压后将得到一个文件夹 hadoop-3.1.4，现在把它拷贝到一个常用的地方：

```
mv hadoop-3.1.4 /usr/local/hadoop
```

然后配置环境变量：

```
echo "export HADOOP_HOME=/usr/local/hadoop" >> /etc/bashrc
echo "export PATH=$PATH:$HADOOP_HOME/bin:$HADOOP_HOME/sbin" >> /etc/bashrc 
```

然后退出 docker 容器并重新进入。

这时，echo $HADOOP_HOME 的结果应该是 /usr/local/hadoop

```
echo "export JAVA_HOME=/usr" >> $HADOOP_HOME/etc/hadoop/hadoop-env.sh
echo "export HADOOP_HOME=/usr/local/hadoop" >> $HADOOP_HOME/etc/hadoop/hadoop-env.sh
```

这两步配置了 hadoop 内置的环境变量，然后执行以下命令判断是否成功：

```
hadoop version
```

## 如果有java错误，找到java安装包位置，添加java环境变量，过程如hadoop

# 单机模式

## 找到昨天新建的hadoop容器

```
docker ps -a
```

## 启动容器

```
docker exec -it  hadoop_single bash
```

## MapReduce 使用

新建input.txt

```shell
touch input.txt
vi input.txt
```

输入以下文字

```txt
I love runoob
I like runoob
I love hadoop
I like hadoop
```

将以上内容用文本编辑器保存。

## 执行 MapReduce：

```shell
hadoop jar $HADOOP_HOME/share/hadoop/mapreduce/hadoop-mapreduce-examples-3.1.4.jar wordcount input.txt output
```

解释一下含义：

hadoop jar从 jar 文件执行 MapReduce 任务，之后跟着的是示例程序包的路径。

wordcount表示执行示例程序包中的 Word Count 程序，之后跟这两个参数，第一个是输入文件，第二个是输出结果的目录名（因为输出结果是多个文件）。

执行之后，应该会输出一个文件夹 output，在这个文件夹里有两个文件：_SUCCESS 和 part-r-00000。

其中 _SUCCESS 只是用于表达执行成功的空文件，part-r-00000 则是处理结果，当我们显示一下它的内容：

```
cat ~/output/part-r-00000
```

![image-20211106154029609](C:\Users\modige\AppData\Roaming\Typora\typora-user-images\image-20211106154029609.png)

# 集群模式

## HDFS 配置与使用

### 新建 hadoop 用户

新建用户，名为 hadoop：

```
adduser hadoop
```

安装一个小工具用于修改用户密码和权限管理：

```
yum install -y passwd sudo
```

设置 hadoop 用户密码：

```
passwd hadoop
```

接下来两次输入密码，一定要记住！

修改 hadoop 安装目录所有人为 hadoop 用户：

```
chown -R hadoop /usr/local/hadoop
```

然后用文本编辑器修改 /etc/sudoers 文件，在

```
root    ALL=(ALL)       ALL
```

之后添加一行

```
hadoop  ALL=(ALL)       ALL
```

然后退出容器。

关闭并提交容器 hadoop_single 到镜像 hadoop_proto：

```
docker stop hadoop_single
docker commit hadoop_single hadoop_proto
```

创建新容器 hdfs_single ：

```
docker run -d --name=hdfs_single --privileged hadoop_proto /usr/sbin/init
```

这样新用户就被创建了。

### 启动 HDFS

现在进入刚建立的容器：

```
docker exec -it hdfs_single su hadoop
```

现在应该是 hadoop 用户：

```
whoami
```

应该显示 "hadoop"

生成 SSH 密钥：

```
ssh-keygen -t rsa
```

这里可以一直按回车直到生成结束。

然后将生成的密钥添加到信任列表：

```
ssh-copy-id hadoop@172.17.0.2
```

从而得知容器的 IP 地址是 172.17.0.2，你们的 IP 可能会与此不同。

在启动 HDFS 以前我们对其进行一些简单配置，Hadoop 配置文件全部储存在安装目录下的 etc/hadoop 子目录下，所以我们可以进入此目录：

```
cd $HADOOP_HOME/etc/hadoop
```

这里我们修改两个文件：core-site.xml 和 hdfs-site.xml

在 core-site.xml 中，我们在 标签下添加属性：

**添加在configuration标签下**

```
<property>
    <name>fs.defaultFS</name>
    <value>hdfs://<你的IP>:9000</value>
</property>
```

在 hdfs-site.xml 中的 标签下添加属性：

```
<property>
    <name>dfs.replication</name>
    <value>1</value>
</property>
```

格式化文件结构：

```
hdfs namenode -format
```

然后启动 HDFS：

```
start-dfs.sh
```
