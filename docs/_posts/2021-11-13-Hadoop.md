```yaml

layout: post
title: "牛蛙"
date: 2021-11-13 17:04:55 -0000
categories: 日记 随笔
```

# Hadoop

## 使用docker模拟服务器集群

## 新建一个linux镜像

```shell
docker pull centos:8
```

## 使用docker images查看本地镜像

```shell
docker images
```

## 新建一个容器

```shell
docker run -d centos:8 /usr/sbin/init
```

## 查看运行中的容器

```shell
docker ps
```

## 使用新创建的容器输出hello world

```shell
docker exec dsafjasfsafa echo "hello world"
```

## 配置java和SSh环境

## 新建容器

```sh
docker run -d --name=java_ssh_proto --privileged centos:8 /usr/sbin/init
```

## 进入容器

```shell
docker exec -it java_ssh_proto bash
```

## 配置镜像

```shell
sed -e 's|^mirrorlist=|#mirrorlist=|g' \
         -e 's|^#baseurl=http://mirror.centos.org/$contentdir|baseurl=https://mirrors.ustc.edu.cn/centos|g' \
         -i.bak \
         /etc/yum.repos.d/CentOS-Linux-AppStream.repo \
         /etc/yum.repos.d/CentOS-Linux-BaseOS.repo \
         /etc/yum.repos.d/CentOS-Linux-Extras.repo \
         /etc/yum.repos.d/CentOS-Linux-PowerTools.repo \
         /etc/yum.repos.d/CentOS-Linux-Plus.repo
yum makecache
```

## 安装 OpenJDK 8 和 SSH 服务：

```bash
yum install -y java-1.8.0-openjdk-devel openssh-clients openssh-server
```

## 启用SSH

```bash
systemctl enable sshd && systemctl start sshd
```

## 保存为一个名为 java_ssh 的镜像

```bash
docker stop java_ssh_proto
docker commit java_ssh_proto java_ssh
```

## Hadoop 安装

### 下载 Hadoop

Hadoop 官网地址：http://hadoop.apache.org/

Hadoop 发行版本下载：https://hadoop.apache.org/releases.html

在目前的测试中，3.1.x 与 3.2.x 版本的兼容性较佳，本教程使用 3.1.4 版本作为案例。

Hadoop 3.1.4 镜像地址，下载好 tar.gz 压缩包文件备用。

### 创建 Hadoop 单机容器

现在以之前保存的 java_ssh 镜像创建容器 hadoop_single：

```bash
docker run -d --name=hadoop_single --privileged java_ssh /usr/sbin/init
```

将下载好的 hadoop 压缩包拷贝到容器中的 /root 目录下：

```bash
docker cp <你存放hadoop压缩包的路径> hadoop_single:/root/
```

进入容器：

```
docker exec -it hadoop_single bash
```

进入 /root 目录：

```
cd /root

```

这里应该存放着刚刚拷贝过来的 hadoop-x.x.x.tar.gz 文件，现在解压它：

```
tar -zxf hadoop-3.1.4.tar.gz
```

解压后将得到一个文件夹 hadoop-3.1.4，现在把它拷贝到一个常用的地方：

```
mv hadoop-3.1.4 /usr/local/hadoop
```

然后配置环境变量：

```
echo "export HADOOP_HOME=/usr/local/hadoop" >> /etc/bashrc
echo "export PATH=$PATH:$HADOOP_HOME/bin:$HADOOP_HOME/sbin" >> /etc/bashrc 
```

更新环境变量文件

```bash
source /etc/bashrc
```



然后退出 docker 容器并重新进入。

这时，echo $HADOOP_HOME 的结果应该是 /usr/local/hadoop

```
echo "export JAVA_HOME=/usr" >> $HADOOP_HOME/etc/hadoop/hadoop-env.sh
echo "export HADOOP_HOME=/usr/local/hadoop" >> $HADOOP_HOME/etc/hadoop/hadoop-env.sh
```

这两步配置了 hadoop 内置的环境变量，然后执行以下命令判断是否成功：

```
hadoop version
```

## 如果有java错误，找到java安装包位置，添加java环境变量，过程如hadoop

centos下安装open-jdk默认路径

```
/usr/lib/jvm/java-1.8.0-openjdk/bin

echo "export JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk" >> /etc/bashrc
echo "export PATH=$PATH:$JAVA_HOME/bin:$JAVA_HOME/sbin" >> /etc/bashrc 
```



# 单机模式

## 找到昨天新建的hadoop容器

```
docker ps -a
```

## 启动容器

```
docker exec -it  hadoop_single bash
```

## MapReduce 使用

新建input.txt

```shell
touch input.txt
vi input.txt
```

输入以下文字

```txt
I love runoob
I like runoob
I love hadoop
I like hadoop
```

将以上内容用文本编辑器保存。

## 执行 MapReduce：

```shell
hadoop jar $HADOOP_HOME/share/hadoop/mapreduce/hadoop-mapreduce-examples-3.1.4.jar wordcount input.txt output
```

解释一下含义：

hadoop jar从 jar 文件执行 MapReduce 任务，之后跟着的是示例程序包的路径。

wordcount表示执行示例程序包中的 Word Count 程序，之后跟这两个参数，第一个是输入文件，第二个是输出结果的目录名（因为输出结果是多个文件）。

执行之后，应该会输出一个文件夹 output，在这个文件夹里有两个文件：_SUCCESS 和 part-r-00000。

其中 _SUCCESS 只是用于表达执行成功的空文件，part-r-00000 则是处理结果，当我们显示一下它的内容：

```
cat ~/output/part-r-00000
```



![image-20211106154029609](https://github.com/modiman/modiman.github.io/blob/gh-pages/docs/_posts/imgs/image-20211106154029609.png?raw=true)





# 集群模式

## HDFS 配置与使用

### 新建 hadoop 用户

新建用户，名为 hadoop：

```
adduser hadoop
```

安装一个小工具用于修改用户密码和权限管理：

```
yum install -y passwd sudo
```

设置 hadoop 用户密码：

```
passwd hadoop
```

接下来两次输入密码，一定要记住！

修改 hadoop 安装目录所有人为 hadoop 用户：

```
chown -R hadoop /usr/local/hadoop
```

然后用文本编辑器修改 /etc/sudoers 文件，在

```
root    ALL=(ALL)       ALL
```

之后添加一行

```
hadoop  ALL=(ALL)       ALL
```

然后退出容器。

关闭并提交容器 hadoop_single 到镜像 hadoop_proto：

```
docker stop hadoop_single
docker commit hadoop_single hadoop_proto
```

创建新容器 hdfs_single ：

```
docker run -d --name=hdfs_single --privileged hadoop_proto /usr/sbin/init
```

这样新用户就被创建了。

### 启动 HDFS

现在进入刚建立的容器：

```
docker exec -it hdfs_single su hadoop
```

现在应该是 hadoop 用户：

```
whoami
```

应该显示 "hadoop"

生成 SSH 密钥：

```
ssh-keygen -t rsa
```

这里可以一直按回车直到生成结束。

然后将生成的密钥添加到信任列表：

```
ssh-copy-id hadoop@172.17.0.2
```

从而得知容器的 IP 地址是 172.17.0.2，你们的 IP 可能会与此不同。

查看容器 IP 地址：

```
ip addr | grep 172
```

在启动 HDFS 以前我们对其进行一些简单配置，Hadoop 配置文件全部储存在安装目录下的 etc/hadoop 子目录下，所以我们可以进入此目录：

```
cd $HADOOP_HOME/etc/hadoop
```

这里我们修改两个文件：core-site.xml 和 hdfs-site.xml

在 core-site.xml 中，我们在 标签下添加属性：

**添加在configuration标签下**

```
<property>
    <name>fs.defaultFS</name>
    <value>hdfs://<你的IP>:9000</value>
</property>
```

在 hdfs-site.xml 中的 标签下添加属性：

```
<property>
    <name>dfs.replication</name>
    <value>1</value>
</property>
```

格式化文件结构：

```
hdfs namenode -format
```

然后启动 HDFS：

```
start-dfs.sh
```

## 5.0 HDFS 集群

### *分类* [Hadoop 教程](https://www.runoob.com/w3cnote_genre/hadoop)

HDFS 集群是建立在 Hadoop 集群之上的，由于 HDFS 是 Hadoop 最主要的守护进程，所以 HDFS 集群的配置过程是 Hadoop 集群配置过程的代表。

使用 Docker 可以更加方便地、高效地构建出一个集群环境。

### 每台计算机中的配置

Hadoop 如何配置集群、不同的计算机里又应该有怎样的配置，这些问题是在学习中产生的。本章的配置中将会提供一个典型的示例，但 Hadoop 复杂多样的配置项远超于此。

HDFS 命名节点对数据节点的远程控制是通过 SSH 来实现的，因此关键的配置项应该在命名节点被配置，非关键的节点配置要在各个数据节点配置。也就是说，数据节点与命名节点的配置可以不同，不同数据节点之间的配置也可以有所不同。

但是本章为了方便建立集群，将使用相同的配置文件通过 Docker 镜像的形式同步到所有的集群节点，特做解释。

### 具体步骤

总体思路是这样的，我们先用一个包含 Hadoop 的镜像进行配置，配置成集群中所有节点都可以共用的样子，然后再以它为原型生成若干个容器，构成一个集群。

### 配置原型

首先，我们将使用之前准备的 hadoop_proto 镜像启动为容器：

```
docker run -d --name=hadoop_temp --privileged hadoop_proto /usr/sbin/init
```

进入 Hadoop 的配置文件目录：

```
cd $HADOOP_HOME/etc/hadoop
```

现在对这里的文件的作用做简单的描述：

| **文件**        | **作用**                             |
| :-------------- | :----------------------------------- |
| workers         | 记录所有的数据节点的主机名或 IP 地址 |
| core-site.xml   | Hadoop 核心配置                      |
| hdfs-site.xml   | HDFS 配置项                          |
| mapred-site.xml | MapReduce 配置项                     |
| yarn-site.xml   | YRAN 配置项                          |

注：YARN 的作用是为 MapReduce 提供资源管理服务，此处暂时用不着。

我们现在设计这样一个简单的集群：

- 1 个命名节点 nn
- 2 个数据节点 dn1, dn2

![img](https://www.runoob.com/wp-content/uploads/2021/02/hdfs-cluster-1.png)

首先编辑 workers ，更改文件内容为：

```
dn1
dn2
```

然后编辑 core-site.xml，在 中添加以下配置项：

```
<!-- 配置 HDFS 主机地址与端口号 -->
<property>
    <name>fs.defaultFS</name>
    <value>hdfs://nn:9000</value>
</property>
<!-- 配置 Hadoop 的临时文件目录 -->
<property>
    <name>hadoop.tmp.dir</name>
    <value>file:///home/hadoop/tmp</value>
</property>
```

配置 hdfs-site.xml，在 中添加以下配置项：

```
<!-- 每个数据块复制 2 份存储 -->
<property>
    <name>dfs.replication</name>
    <value>2</value>
</property>

<!-- 设置储存命名信息的目录 -->
<property>
    <name>dfs.namenode.name.dir</name>
    <value>file:///home/hadoop/hdfs/name</value>
</property>
```

最后需要配置一下 SSH ：

```
ssh-keygen -t rsa -P "" -f ~/.ssh/id_rsa
ssh-copy-id -i ~/.ssh/id_rsa hadoop@localhost
```

到此为止，集群的原型就配置完毕了，可以退出容器并上传容器到新镜像 cluster_proto ：

```
docker stop hadoop_temp
docker commit hadoop_temp cluster_proto
```

此处如果有必要可以删除临时镜像 hadoop_temp 。

## 部署集群

接下来部署集群。

首先，要为 Hadoop 集群建立专用网络 hnet ：

```
docker network create --subnet=172.20.0.0/16 hnet
```

接下来创建集群容器：

```
docker run -d --name=nn --hostname=nn --network=hnet --ip=172.20.1.0 --add-host=dn1:172.20.1.1 --add-host=dn2:172.20.1.2 --privileged cluster_proto /usr/sbin/init
docker run -d --name=dn1 --hostname=dn1 --network=hnet --ip=172.20.1.1 --add-host=nn:172.20.1.0 --add-host=dn2:172.20.1.2 --privileged cluster_proto /usr/sbin/init
docker run -d --name=dn2 --hostname=dn2 --network=hnet --ip=172.20.1.2 --add-host=nn:172.20.1.0 --add-host=dn1:172.20.1.1 --privileged cluster_proto /usr/sbin/init
```

进入命名节点：

```
docker exec -it nn su hadoop
```

格式化 HDFS：

```
hdfs namenode -format
```

如果没有出错，那么下一步就可以启动 HDFS：

```
start-dfs.sh
```

成功启动之后，jps 命令应该能查到 NameNode 和 SecondaryNameNode 的存在。命名节点不存在 DataNode 进程，因为这个进程在 dn1 和 dn2 中运行。

至此，你可以像上一章中讲述伪集群模式时所说的方法检测 HDFS 的运行，使用 HDFS 的方式也没有差别（命名节点代表整个集群）。

### hdfss状态

```bash
hadoop dfsadmin 
```

