# 数据集

## ogbl-biokg

### 概述

ogbl-biokg数据集是一个知识图(kg)，它是我们使用大量生物医学数据仓库的数据创建的。它包含5种类型的实体:

| 结点类型 | 疾病  | 蛋白质 | 药物  | 副作用 | 蛋白质功能 |
| -------- | ----- | ------ | ----- | ------ | ---------- |
| 结点数量 | 10687 | 17499  | 10533 | 9969   | 45085      |

### 关系


连接两类实体的有向关系共有51种，包括39种药物-药物相互作用、8种蛋白质-蛋白质相互作用，以及药物-蛋白质、药物-副作用、药物-蛋白质、功能-功能关系。所有关系都被建模为有向边，其中连接相同实体类型(例如，蛋白质-蛋白质、药物-药物、功能-功能)的关系总是对称的，即边是双向的。

### 研究意义

该数据集与生物医学和基础ML研究都相关。在生物医学方面，该数据集使我们能够更好地了解人类生物学，并生成可以指导下游生物医学研究的预测。在最基本的最大似然方面，数据集在处理可能有矛盾观测值的噪声、不完整的KG时带来了挑战。这是因为ogbl-biokg数据集涉及从分子规模(例如，细胞内的蛋白质-蛋白质相互作用)到整个群体(例如，特定国家患者经历的不良副作用的报告)的异质性相互作用。此外，KG中的三元组来自具有各种置信水平的来源，包括实验读数、人工辅助注释和自动提取的元数据。

### 预测任务:

任务是预测给定训练三元组的新三元组。评估协议与ogbl-wiki G2完全相同，只是这里我们只考虑针对相同类型的实体进行排名。例如，当腐蚀蛋白质类型的头部实体时，我们只考虑负蛋白质实体。

### 数据集分割

对于这个数据集，我们采用随机分割。虽然根据时间分割三元组是一个有吸引力的选择，但我们注意到，获得关于三元组背后的单个实验和观察是何时进行的准确信息是非常具有挑战性的。我们努力在OGB的未来版本中提供额外的数据集分割



### 数据载入方法

```python
from ogb.linkproppred import PygLinkPropPredDataset

dataset = PygLinkPropPredDataset(name = d_name) 

split_edge = dataset.get_edge_split()
train_edge, valid_edge, test_edge = split_edge["train"], split_edge["valid"], split_edge["test"]
graph = dataset[0] # pyg graph object containing only training edges
```

dataset存储形式

```json
dataset[0]=
{
    'edge_index_dict':
    {
        ('disease', 'disease-protein', 'protein'): array([[ 1718, ...,   1198],  [ 3207...,1962]]), 
		('drug', 'drug-disease', 'disease'): array([[1411 ...,  679], [1402, ...,  2416]]),
			...(共51行，对应51个关系)  

    }，
	'edge_feat_dict': None,
	'node_feat_dict': None,
	'num_nodes_dict': {'disease': 10687, 'drug': 10533, 'function': 45085, 'protein': 17499, 'sideeffect': 9969},
		
	'edge_reltype': {('disease', 'disease-protein', 'protein'): array([[0],  [0],  ...
       [0]]), ('drug', 'drug-disease', 'disease'): array([[1],       [1],...
                                                          
 }

}
dataset只包含一张图biokg，故长度为1;
dataset[0]包含5个key                                                   
```

### 变量名解释

The library-agnostic graph object is a dictionary containing the following keys: `edge_index`, `edge_feat`, `node_feat`, and `num_nodes`, which are detailed below.

- `edge_index`:形状为(2, num_edges)的numpy数组，一列表示一个边，第一行、第二行表示头、尾节点的索引，无向边表示为双向边
- `edge_feat`: 形状为(num_edges, edgefeat_dim)的numpy数组， `edgefeat_dim`是边特征的维度，一行表示一个边的特征，如果没有输入，
- `node_feat`: numpy ndarray of shape `(num_nodes, nodefeat_dim)`, where `nodefeat_dim` is the dimensionality of node features and i-th row represents the feature of i-th node. This can be `None` if no input node features are available.
- `num_nodes`: 图节点数量

**Heterogeneous graph:** We represent a heterogeneous graph using dictionaries: `edge_index_dict`, `edge_feat_dict`, `node_feat_dict`, and `num_nodes_dict`.

- `edge_index_dict`:将三元组映射为与 `edge_index`.相关的字典
- `edge_feat_dict`: A dictionary mapping each triplet `(head type, relation type, tail type)` into corresponding `edge_feat`.
- `node_feat_dict`: A dictionary mapping each `node type` into corresponding `node_feat`.
- `num_nodes_dict`: A dictionary mapping each `node type` into corresponding `num_nodes`.

**Note:** 一些图形数据集可能在节点或边中包含额外的元信息，例如它们的时间戳。尽管它们没有作为默认输入特征给出，但研究人员应该可以随意利用这些附加信息

### 性能评估

​     评估器是为每个数据集定制的。我们要求用户将预先指定的格式传递给评估者。首先，请学习评估器的输入输出格式规范如下。



```python
from ogb.linkproppred import Evaluator
evaluator = Evaluator(name = d_name)
print(evaluator.expected_input_format) 
print(evaluator.expected_output_format) 
```



### 环境 服务器149

* python 3.7.11
* torch 1.7.1
* cuda 11.4
* ogb 1.3.2

# 1.Auto-SF 

##  1.1论文部分

### 概述 

* 数据集 OGB-biokg
* 消耗显存  9G
* 完全复现





# KGB Rotate

* 数据集 FB15K
* 显存不足无法复现

报错信息

```bash
RuntimeError: CUDA out of memory. Tried to allocate 1.95 GiB (GPU 0; 10.76 GiB total capacity; 8.44 GiB already allocated; 661.44 MiB free; 9.14 GiB reserved in total by PyTorc
```

使用nvidia-smi发现并没有进程在运行，显存也未被占用

**这说明为程序分配8.44GiB显存后无法继续分配报错，进而程序停止，就是说显卡内存不足**

* TransE模型可以试试



# 日记

## 1-11

* 运行pairRE提供的代码，提示没有ogb包



## 1-12 

解决昨天的报错
昨天以为装上了，实际装obg失败了，原因是卡在了torch安装这一步
今天单独安装torch ，因为是在windows上配置环境，在安装torch时按选择没有cuda的cpu-only版本
命令

```
conda install pytorch torchvision torchaudio cpuonly -c pytorch

```

网上说一般人学习只用cpu-only的torch版本就可以，希望没问题
pairre模型用的是16G显存的显卡，试试我的amd cpu顶不顶
现在在下数据集，希望能成功，
运行失败，源代码调用了cuda，本机没有

##  3-1

* Auto-SF源码 run.py

## 3-2 

* run.py   319行，do_train部分
* model.py

### 思考

OGB给出的实例文件中包含模型如下

* * TransE 
  * DistMult
  * ComplEx
  * RotatE

  等主流模型，这意味着对比实验不需要自己实现，实现自己的想法时只需要将自己的模型加到model.py中即可

  现在的问题是看懂各个参数的意义，比如mode、数据评估eval等，这样才知道如何通过现有代码以最小的改动实现自己的想法

# 实验结果对比

各数据集概述

| Dataset   | Train     | Valid  | Test   | Entities | Relations |
| --------- | --------- | :----- | ------ | -------- | --------- |
| FB15K-237 | 272,115   | 17,535 | 20,466 | 14,541   | 237       |
| WN18RR    | 86,835    | 3,034  | 3,134  | 40,943   | 11        |
| FB15K     | 483,142   | 50,000 | 59,071 | 14,951   | 1,345     |
| WN18      | 141,442   | 5,000  | 5,000  | 40,943   | 18        |
| YAGO3-10  | 1,079,040 | 5,000  | 5,000  | 123,182  | 37        |
| WN11      | 110,361   | 5,215  | 21,035 | 38,194   | 11        |
| FB13      | 316,232   | 11,816 | 47,464 | 75,043   | 13        |

## How does kge...

![](https://gitee.com/modige/modige/raw/master/_posts/imgs/SEGNNRE.png)

## Ampligraph

* FB15K-237 validation and test sets include triples with entities that do not occur in the training set. We found 8 unseen entities in the validation set and 29 in the test set. In the experiments we excluded the triples where such entities appear (9 triples in from the validation set and 28 from the test set).

### 文档数据

#### 

#### WR18RR

| Model      | MR   | MRR  | Hits@1 | Hits@3 | Hits@10 | Hyperparameters                                     |
| ---------- | ---- | ---- | ------ | ------ | ------- | --------------------------------------------------- |
| TransE     | 2692 | 0.22 | 0.03   | 0.37   | 0.54    | k: 350; epochs: 4000; eta: 30;  batches_count: 150; |
| DistMult   | 5531 | 0.47 | 0.43   | 0.48   | 0.53    | k: 350; epochs: 4000; eta: 30;  batches_count: 100; |
| ComplEx    | 4177 | 0.51 | 0.46   | 0.53   | 0.58    | k: 200; epochs: 4000; eta: 20; batches_count: 10;   |
| HolE       | 7028 | 0.47 | 0.44   | 0.48   | 0.53    | k: 200; epochs: 4000;batches_count: 50;             |
| ConvKB     | 3652 | 0.39 | 0.33   | 0.42   | 0.48    | k: 200; epochs: 500;  batches_count: 300;           |
| ConvE      | 5346 | 0.45 | 0.42   | 0.47   | 0.52    | k: 200; epochs: 4000; batches_count: 100;           |
| ConvE(1-N) | 4842 | 0.48 | 0.45   | 0.49   | 0.54    | k: 200; epochs: 4000; l                             |

#### WN18

| Model      | MR   | MRR  | Hits@1 | Hits@3 | Hits@10 | Hyperparameters                                              |
| ---------- | ---- | ---- | ------ | ------ | ------- | ------------------------------------------------------------ |
| TransE     | 260  | 0.66 | 0.44   | 0.88   | 0.95    | k: 150; epochs: 4000; eta: 10; batches_count: 100;           |
| DistMult   | 675  | 0.82 | 0.73   | 0.92   | 0.95    | k: 200; epochs: 4000; eta: 20;  batches_count: 50;           |
| ComplEx    | 726  | 0.94 | 0.94   | 0.95   | 0.95    | k: 200; epochs: 4000; eta: 20; loss: nll; loss_params: margin: 1; optimizer: adam; optimizer_params: lr: 0.0005; seed: 0; batches_count: 50; |
| HolE       | 665  | 0.94 | 0.93   | 0.94   | 0.95    | k: 200; epochs: 4000; eta: 20; batches_count: 50;            |
| ConvKB     | 331  | 0.80 | 0.69   | 0.90   | 0.94    | k: 200; epochs: 500; eta: 10； batches_count: 300;           |
| ConvE      | 492  | 0.93 | 0.91   | 0.94   | 0.95    | k: 300; epochs: 4000; batches_count: 100;                    |
| ConvE(1-N) | 436  | 0.95 | 0.93   | 0.95   | 0.95    | k: 300; epochs: 4000;                                        |

#### FB15K

| Model      | MR   | MRR  | Hits@1 | Hits@3 | Hits@10 | Hyperparameters                                    |
| ---------- | ---- | ---- | ------ | ------ | ------- | -------------------------------------------------- |
| TransE     | 44   | 0.63 | 0.50   | 0.73   | 0.85    | k: 150; epochs: 4000; eta: 10; batches_count: 100; |
| DistMult   | 179  | 0.78 | 0.74   | 0.82   | 0.86    | k: 200; epochs: 4000; eta: 20; batches_count: 50;  |
| ComplEx    | 184  | 0.80 | 0.76   | 0.82   | 0.86    | k: 200; epochs: 4000; eta: 20; batches_count: 100; |
| HolE       | 216  | 0.80 | 0.76   | 0.83   | 0.87    | k: 200; epochs: 4000; eta: 20batches_count: 50;    |
| ConvKB     | 331  | 0.65 | 0.55   | 0.71   | 0.82    | k: 200; epochs: 500; eta: 10;batches_count: 300;   |
| ConvE      | 385  | 0.50 | 0.42   | 0.52   | 0.66    | k: 300; epochs: 4000; batches_count: 100;          |
| ConvE(1-N) | 55   | 0.80 | 0.74   | 0.84   | 0.89    | k: 300; epochs: 4000;                              |

#### FB15k-237

| Model      | MR   | MRR  | Hits@1 | Hits@3 | Hits@10 | Hyperparameters                                              |
| ---------- | ---- | ---- | ------ | ------ | ------- | ------------------------------------------------------------ |
| TransE     | 208  | 0.31 | 0.22   | 0.35   | 0.50    | k: 400; epochs: 4000; eta: 30;; batches_count: 64;           |
| DistMult   | 199  | 0.31 | 0.22   | 0.35   | 0.49    | k: 300; epochs: 4000; eta: 50; batches_count: 50;            |
| ComplEx    | 184  | 0.32 | 0.23   | 0.35   | 0.50    | k: 350; epochs: 4000; eta: 30; loss: multiclass_nll; optimizer: adam; optimizer_params: lr: 0.00005; seed: 0; regularizer: LP; regularizer_params: lambda: 0.0001; p: 3; batches_count: 64; |
| HolE       | 184  | 0.31 | 0.22   | 0.34   | 0.49    | k: 350; epochs: 4000; eta: 50; batches_count: 64;            |
| ConvKB     | 327  | 0.23 | 0.15   | 0.25   | 0.40    | k: 200; epochs: 500; eta: 10;  batches_count: 300;           |
| ConvE      | 1060 | 0.26 | 0.19   | 0.28   | 0.38    | k: 200; epochs: 4000; batches_count: 100;                    |
| ConvE(1-N) | 234  | 0.32 | 0.23   | 0.35   | 0.50    | k: 200; epochs                                               |

### 我的复现

#### FB15k-237

| Model      | 结束时损失 | MRR  | Hits@1 | Hits@3 | Hits@10 | epoch  | dim    |
| ---------- | ---------- | ---- | ------ | ------ | ------- | ------ | ------ |
| TransE     | 0.204731   | 0.15 | .0.09  | .16    | .27     | 50     | 10     |
| TransE     | 0.027393   | 0.23 | 0.15   | 0.25   | 0.39    | 100    | 100    |
| ComplEx    |            | 0.15 | .09    | .16    | 0.26    | 50     | 100    |
| ComplEx    |            | 0.23 | 0.14   | 0.26   | 0.41    | １００ | ３５０ |
| ConvKB     |            |      |        |        |         |        |        |
| ConvE      |            |      |        |        |         |        |        |
| ConvE(1-N) |            |      |        |        |         |        |        |



##  

