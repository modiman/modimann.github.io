```yaml
layout: post
title: "neo4j数据迁移"
date: 2021-11-13 17:04:55 -0000
categories: 日记 随笔
```



## Neo4j数据迁移

从服务器迁移到本机

**原理 将存储数据库的文件data从服务器挪到本机即可**

1. 找到数据库存放的位置

   我的neo4j启动命令为

   ```bash
   docker run   --name=hm  --publish=7474:7474 --publish=7687:7687    --volume=/home/modige/neo4j/data:/data      -d neo4j
   ```

从命令可以看到数据存放在路径$HOME/neo4j/data下

利用echo命令从终端查看其绝对路径

```bash
echo $HOME
```

输出/root，可知数据的绝对路径为 **\root\neo4j\data**

到该路径下可以找到这一文件夹

将neo4j整个文件夹移动到目标主机

```bash
root@master:~# scp -rp neo4j/ modige@172.xx.xx.xx:/home/modige
```

来到本地主机，启动neo4j，在启动时指定数据库存储路径

```bash
root@modige-Lenovo:/home/modige# docker run   --name=hm  --publish=7474:7474 --publish=7687:7687     --volume=/home/modige/neo4j/data:/data     --rm -d neo4j
```

在浏览器中即可访问，密码应该与与数据库密码相同

## 根据导出的json恢复图

```python
import codecs

# 安装方法  pip install py2neo
from py2neo.data import Node, Relationship
from py2neo import Graph
import json


class json2neo:
    def __init__(self):
        '''
          重要  重要  重要
         运行之前在自己的电脑上安装并运行neo4j数据库，否则运行不会成功
         重要  重要  重要

         如果数据库在远程主机，host改成远程ip，在本地则不用改
         将 user 和 password改成自己的
         端口号port为默认端口，一般不用改
        '''


        self.graph = Graph(host="127.0.0.1",user='neo4j',password='123456',port='7687')
    def json2neo(self,fname):
        with codecs.open (fname,'r', 'utf_8_sig') as fp:

            # 将json数据读取出来，存放在字典列表中
            data = json.load(fp)
            graph = self.graph

            for i in data:
                # 取出头结点，尾节点，关系

                label_start = i['p']["segments"][0]['start']['labels'][0]
                name_start =  i['p']["segments"][0]['start']['properties']['name']

                label_end = i['p']["segments"][0]['end']['labels'][0]
                name_end = i['p']["segments"][0]['end']['properties']['name']

                rel = i['p']["segments"][0]['relationship']['type']


                # 查询节点是否存在，不存在则创建
                ex_start = 'MATCH (n:`'+  label_start + '`) where n.name = "'+ name_start + '" RETURN n '
                tx = graph.begin()
                if len(graph.run(ex_start).data()) ==0 :
                    tx.create(Node(label_start,name=name_start))
                    graph.commit(tx)
                    print('节点'+name_start+'创建成功')
                else:print('节点已存在')

                ex_end = 'MATCH (n:`' + label_end + '`) where n.name = "' + name_end + '" RETURN n '
                tx = graph.begin()
                if len(graph.run(ex_end).data()) == 0:
                    tx.create(Node(label_end, name=name_end))
                    graph.commit(tx)
                    print('节点' + name_start + '创建成功')
                else:
                    print('节点已存在')


                # 创建关系，这里默认关系是不存在的，如果重复执行会重复创建关系，只执行一遍不会出现重复关系
                # 如果重复创建了可以执行下面的cleargraph函数清空数据库，之后重新执行本函数
                # 也可以自己写一下检查关系是否存在的函数，之后再判断是否添加关系

                cql = "MATCH (a:`" +label_start + "`),(b:`" +label_end+ "`) WHERE a.name = '" + name_start + "' AND b.name = '" + name_end + "' CREATE (a)-[r:"+rel+"]->(b) RETURN r"
                graph.run(cql)
                print(rel+'关系创建成功')


    def cleargraph(self):
        #
        # 此函数用来将数据库清空
        graph = self.graph
        cql = 'MATCH p=()-->() delete p'
        graph.run(cql)




if __name__ == '__main__':

    e = json2neo()
    e.json2neo('知识图谱.json')
    # e.cleargraph()
```

