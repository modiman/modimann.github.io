## 业务背景

用户请求全部发送到同一台服务器，压力太大，这台服务器宕机会导致整个服务停止工作

解决思路：设置多态服务器，然后设置一个中间服务器，让这台服务器负责接受请求，然后判断哪台服务器负载比较低，将当前请求发送给负载比较低的服务器 nginx

## 负载均衡算法



| 算法                | 解释                                                         | 优点 | 缺点                       |
| ------------------- | ------------------------------------------------------------ | ---- | -------------------------- |
| 轮转（Round Robin） | 轮流发送给各个服务器，适合服务器处理能力相同、每个业务处理量差不多的场景 |      |                            |
| 加权轮转            | 给性能更好地服务器更高的权重，能者多劳                       |      |                            |
| 最少连接            | 选择当前连接最少的服务器                                     |      |                            |
| IP Hash             | 给每个请求ip指定一台特定的服务器，保证一个特定用户会访问一个特定服务器 |      | 添加节点导致服务器hash变化 |
| 一致性哈希          |                                                              |      |                            |

### 一致性哈希

即使增加或减少服务器也能尽可能保证负载均衡，不会让请求hash到某一部分或忽略某一部分

**实现方式**：

1. 组织一个2<sup>32-1</sup>的圆，根据服务器的ip或名称将服务器hash到这个圆上
2. 当某个ip请求到达时，计算其hash值，找到该hash在圆上的位置，从这个位置开始顺时针往后找，第一个找到的节点就是要给他分配的服务器![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/386596fec64446e497dea0a76ce0a338~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image)

**问题**：如果服务器的ip经过hash集中在某几个区域，算法仍然不能真正的起到负载均衡的作用

**解决**：虚拟节点机制

* 为每个服务器计算多个hash值，把这些值都映射到圆上，请求到来时遇到某个虚拟节点都分配到这台服务器

## 健康监测

选择某个服务器的前提是该服务器要是健康的

为了监控健康的服务器，健康检查一般会通过配置的协议和端口尝试去连接服务器来保证服务器正在监听。如果一个服务器的健康检查失败了，也就是说服务器无法正常响应请求，那么就会被自动的移除池子中，流量也不会被分配到这个坏掉的服务器直到它能通过健康检查。

## 反向代理 nginx

将服务打成多个jar包，使用不同端口号，在服务器上运行，在nginx配置文件中进行配置。

只需要在服务器下载nginx并开启服务，在配置文件加入需要被映射的服务器并选择合适的负载均衡算法就能实现

![img](https://img-blog.csdnimg.cn/img_convert/d82c48d9671ecedb5c161101dd5f63f8.png)

* 正向代理：客户端不知道真正的服务端
* 反向代理：服务端不知道真正的客户端

**配置**：通过nginx.conf配置

```sh
    
http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;
    server {

        listen       8081;
        server_name  localhost;

        location / {
            proxy_pass      http://0.0.0.0:9000;
        }

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }
}
```

**开启服务**:前端

```js
const http = require('http');
const server = http.createServer();
const host = '0.0.0.0'
const port = 9000
let n = 0
server.on('request', function (req, res) {
  n += 1
  console.log('请求来了: ', n)
  res.write('Hello World!!!');
  res.end();
});
server.listen(port, host, function () {
  console.log(`服务器启动了，请访问：http://${host}:${port}`);
})
```

访问 `http://localhost:8081/` ， `nginx` 已经能把请求正常打到 `node 9000` 端口的服务了

